<!DOCTYPE html>
<html>
<head>
  <title>Dory Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{font-family:Arial;background:#f6efe4;margin:0}
    header{background:#673f16;color:#fff;padding:15px;font-size:22px}
    .container{padding:25px}
    .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);margin-bottom:25px}
    label{font-weight:600}
    input,textarea{width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:6px}
    button{background:#673f16;color:#fff;border:none;padding:10px 18px;border-radius:8px;margin-top:10px;cursor:pointer}
    button:hover{background:#84522b}
    table{width:100%;border-collapse:collapse;margin-top:15px}
    th,td{padding:10px;border-bottom:1px solid #ddd}
    img{width:70px;height:70px;border-radius:8px;object-fit:cover}
    .delete-btn{background:red}
  </style>
</head>

<body>

<header>Dory's Admin Panel</header>

<div class="container">

  <!-- ================= PRODUCTS ================= -->
  <div class="card">
    <h2>Add Product</h2>

    <label>Name</label>
    <input id="productName"/>

    <label>Price</label>
    <input id="productPrice" type="number"/>

    <label>Description</label>
    <textarea id="productDescription"></textarea>

    <label>Product Image</label>
    <input type="file" id="productImage"/>

    <button onclick="saveProduct()">Save Product</button>
    <p id="pmsg"></p>
  </div>


  <div class="card">
    <h2>Products</h2>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Image</th>
        <th>Name</th>
        <th>Price</th>
        <th>Description</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody id="productBody"></tbody>
    </table>
  </div>



  <!-- ================= GALLERY ================= -->
  <div class="card">
    <h2>Upload Gallery Images (Multiple)</h2>

    <input type="file" id="galleryFiles" multiple />
    <button onclick="uploadGallery()">Upload</button>

    <p id="gmsg"></p>
  </div>


  <div class="card">
    <h2>Gallery Images</h2>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Image</th>
        <th>Action</th>
      </tr>
      </thead>
      <tbody id="galleryBody"></tbody>
    </table>
  </div>


  <div class="card">
    <h2>Today's Bake</h2>

    <label>Name</label>
    <input id="tName"/>

    <label>Ingredients / Description</label>
    <textarea id="tIngredients"></textarea>

    <label>Today's Bake Image</label>
    <input type="file" id="tImage"/>

    <button onclick="saveToday()">Save Today‚Äôs Bake</button>
    <p id="tmsg"></p>
  </div>


  <!-- ================= ABOUT ================= -->
  <div class="card">
    <h2>Update About</h2>

    <label>Title</label>
    <input id="aTitle"/>

    <label>Description 1</label>
    <textarea id="aDesc1"></textarea>

    <label>Description 2</label>
    <textarea id="aDesc2"></textarea>

    <button onclick="saveAbout()">Save About</button>
    <p id="amsg"></p>
  </div>


  <!-- ================= REVIEWS ================= -->
  <div class="card">
    <h2>Reviews</h2>
    <table>
      <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Review</th>
        <th>Rating</th>
      </tr>
      </thead>
      <tbody id="reviewBody"></tbody>
    </table>
  </div>

</div>



<script>

  const API = window.location.origin;

  /* ================= SAVE PRODUCT ================= */
  function saveProduct() {
    const form = new FormData();
    form.append("name", productName.value);
    form.append("price", productPrice.value);
    form.append("description", productDescription.value);
    form.append("image", productImage.files[0]);   // MUST be image

    fetch("/api/products", {
      method: "POST",
      body: form
    })
            .then(r => r.json())
            .then(res => {
              console.log("SUCCESS", res);
              alert("Product Saved");
              loadProducts();
            })
            .catch(err => console.error("ERROR", err));
  }


  /* ================= LOAD PRODUCTS ================= */
  async function loadProducts(){
    const res = await fetch(`${API}/api/products`);
    const list = await res.json();

    const body = document.getElementById("productBody");
    body.innerHTML="";

    list.forEach((p,i)=>{

      body.innerHTML += `
<tr>
<td>${i+1}</td>
<td><img src="${p.imageUrl}"></td>
<td>${p.name}</td>
<td>${p.price}</td>
<td>${p.description}</td>
<td><button class="delete-btn" onclick="deleteProduct(${p.id})">Delete</button></td>
</tr>`;
    });
  }


  /* ================= DELETE PRODUCT ================= */
  async function deleteProduct(id){
    if(!confirm("Delete product?")) return;
    await fetch(`${API}/api/products/${id}`,{ method:"DELETE" });
    loadProducts();
  }



  /* ================= UPLOAD GALLERY ================= */
  async function uploadGallery(){

    let files = galleryFiles.files;
    if(!files.length){
      alert("Select files");
      return;
    }

    const form = new FormData();
    for(let f of files){
      form.append("files", f);
    }

    const res = await fetch(`${API}/api/gallery`,{
      method:"POST",
      body:form
    });

    gmsg.innerHTML = res.ok ? "Uploaded üéâ" : "Failed";
    loadGallery();
  }


  /* ================= LOAD GALLERY ================= */
  async function loadGallery(){
    const res = await fetch(`${API}/api/gallery`);
    const imgs = await res.json();

    const body = document.getElementById("galleryBody");
    body.innerHTML="";

    imgs.forEach((g,i)=>{
      body.innerHTML+=`
<tr>
<td>${i+1}</td>
<td><img src="${g.url}"></td>
<td><button class="delete-btn" onclick="deleteGallery(${g.id})">Delete</button></td>
</tr>`;
    });
  }


  /* ================= DELETE GALLERY ================= */
  async function deleteGallery(id){
    if(!confirm("Delete image?")) return;
    await fetch(`${API}/api/gallery/${id}`,{ method:"DELETE" });
    loadGallery();
  }


  /* ================= ABOUT ================= */
  async function loadAbout(){
    const r = await fetch(`${API}/api/about`);
    const a = await r.json();

    aTitle.value = a.title;
    aDesc1.value = a.description;
    aDesc2.value = a.description2;
  }

  async function saveAbout(){
    const res = await fetch(`${API}/api/about`,{
      method:"POST",
      headers:{ "Content-Type":"application/json"},
      body: JSON.stringify({
        title:aTitle.value,
        description:aDesc1.value,
        description2:aDesc2.value
      })
    });

    amsg.innerHTML = res.ok ? "Updated üéâ" : "Failed";
  }



  /* ================= REVIEWS ================= */
  async function loadReviews(){
    const r = await fetch(`${API}/api/reviews`);
    const list = await r.json();

    const body=document.getElementById("reviewBody");
    body.innerHTML="";

    list.forEach((r,i)=>{
      body.innerHTML+=`
<tr>
<td>${i+1}</td>
<td>${r.name}</td>
<td>${r.message}</td>
<td>${"‚≠ê".repeat(r.rating)}</td>
</tr>`;
    });
  }

  async function saveToday(){
    const name = tName.value;
    const ingredients = tIngredients.value;
    const file = tImage.files[0];

    if(!file){
      alert("Select image");
      return;
    }

    const form = new FormData();
    form.append("name", name);
    form.append("ingredients", ingredients);
    form.append("image", file);

    const res = await fetch(`${API}/api/today`,{
      method:"POST",
      body: form
    });

    if(res.ok){
      tmsg.innerHTML = "Today‚Äôs Bake Updated üéâ";
    }else{
      tmsg.innerHTML = "Failed";
    }
  }



  /* INIT */
  loadProducts();
  loadGallery();
  loadAbout();
  loadReviews();

</script>

</body>
</html>
